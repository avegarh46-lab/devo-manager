<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEVO Mobile Manager</title>
    <link rel="manifest" href="manifest.json">
    
    <!-- UI Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK (Version Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- React & Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { background-color: #020617; color: white; margin: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { color: #3b82f6; transform: translateY(-2px); transition: all 0.3s ease; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyC7-l7LkpXzdebsGINhg49zPy3XAEtqtUw",
            authDomain: "devo-manager.firebaseapp.com",
            projectId: "devo-manager",
            storageBucket: "devo-manager.firebasestorage.app",
            messagingSenderId: "622771552963",
            appId: "1:622771552963:web:73af8de96d646fb1da1876",
            measurementId: "G-2KE1DXB30E"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const { useState, useEffect } = React;

        function App() {
            const [activeTab, setActiveTab] = useState('home');
            const [editMode, setEditMode] = useState(false);
            const [loading, setLoading] = useState(true);
            const [saldo, setSaldo] = useState(0);
            const [members, setMembers] = useState([]);
            const [history, setHistory] = useState([]);
            const [newTrx, setNewTrx] = useState({ ket: '', total: '', tipe: 'masuk' });
            const [editingId, setEditingId] = useState(null);

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

            useEffect(() => {
                const unsubFinance = db.collection("settings").doc("finance").onSnapshot(doc => {
                    if (doc.exists) setSaldo(doc.data().saldo || 0);
                    else db.collection("settings").doc("finance").set({ saldo: 0 });
                    setLoading(false);
                }, err => setLoading(false));

                const unsubMembers = db.collection("members").orderBy("id", "asc").onSnapshot(snap => {
                    const data = snap.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
                    if (data.length === 0) initMembers();
                    else setMembers(data);
                });

                const unsubTrx = db.collection("transactions").orderBy("date", "desc").limit(10).onSnapshot(snap => {
                    setHistory(snap.docs.map(doc => ({ idDoc: doc.id, ...doc.data() })));
                });

                return () => { unsubFinance(); unsubMembers(); unsubTrx(); };
            }, []);

            const initMembers = async () => {
                const batch = db.batch();
                for (let i = 1; i <= 50; i++) {
                    const ref = db.collection("members").doc(`member_${i}`);
                    batch.set(ref, { id: i, name: `PEMAIN ${i}`, whatsapp: '', paid: {} });
                }
                await batch.commit();
            };

            const updateMemberData = async (idDoc, field, value) => {
                try {
                    await db.collection("members").doc(idDoc).update({ [field]: value });
                } catch (e) {
                    console.error("Update error:", e);
                }
            };

            const addTransaction = async () => {
                if (!newTrx.ket || !newTrx.total) return alert("Isi keterangan dan jumlah!");
                const amount = Number(newTrx.total);
                const newSaldo = newTrx.tipe === 'masuk' ? saldo + amount : saldo - amount;
                
                try {
                    await db.collection("transactions").add({
                        ...newTrx,
                        total: amount,
                        date: firebase.firestore.Timestamp.now()
                    });
                    await db.collection("settings").doc("finance").update({ saldo: newSaldo });
                    setNewTrx({ ket: '', total: '', tipe: 'masuk' });
                } catch (e) {
                    alert("Error: " + e.message);
                }
            };

            const toggleIuran = async (idDoc, currentPaid, month) => {
                const updatedPaid = { ...currentPaid, [month]: !currentPaid[month] };
                await db.collection("members").doc(idDoc).update({ paid: updatedPaid });
            };

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-950 text-white">
                    <div className="text-center">
                        <div className="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                        <p className="text-[10px] font-black uppercase tracking-widest animate-pulse">Menghubungkan Database...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-950 pb-32 max-w-md mx-auto relative shadow-2xl border-x border-white/5">
                    {/* Header */}
                    <header className="p-6 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-md z-50 border-b border-white/5">
                        <h1 className="font-black italic text-xl tracking-tighter uppercase">DEVO <span className="text-blue-500">Mobile</span></h1>
                        <button 
                            onClick={() => { setEditMode(!editMode); setEditingId(null); }}
                            className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${editMode ? 'bg-green-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400'}`}
                        >
                            {editMode ? 'SIMPAN' : 'MODE ADMIN'}
                        </button>
                    </header>

                    <main className="px-6 pt-6 text-white">
                        {activeTab === 'home' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-950 p-8 rounded-[2.5rem] shadow-xl relative overflow-hidden border border-white/10">
                                    <p className="text-[10px] font-black text-blue-200 uppercase tracking-widest opacity-60">Saldo Kas Devo</p>
                                    <h2 className="text-4xl font-black mt-2 tracking-tighter">Rp {Number(saldo).toLocaleString('id-ID')}</h2>
                                </div>

                                {editMode && (
                                    <div className="glass p-6 rounded-3xl space-y-4 border-blue-500/20 border animate-in slide-in-from-top-4 duration-300">
                                        <h3 className="text-xs font-black uppercase tracking-widest text-blue-400">Input Kas</h3>
                                        <input placeholder="Keterangan..." className="w-full bg-slate-900 p-3 rounded-xl text-sm outline-none border border-white/5 focus:border-blue-500" 
                                            value={newTrx.ket} onChange={e => setNewTrx({...newTrx, ket: e.target.value})} />
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="Jumlah" className="flex-1 bg-slate-900 p-3 rounded-xl text-sm outline-none border border-white/5" 
                                                value={newTrx.total} onChange={e => setNewTrx({...newTrx, total: e.target.value})} />
                                            <select className="bg-slate-900 p-3 rounded-xl text-xs font-bold outline-none border border-white/5"
                                                value={newTrx.tipe} onChange={e => setNewTrx({...newTrx, tipe: e.target.value})}>
                                                <option value="masuk">Masuk</option>
                                                <option value="keluar">Keluar</option>
                                            </select>
                                        </div>
                                        <button onClick={addTransaction} className="w-full bg-blue-600 py-3 rounded-xl font-black text-xs uppercase shadow-lg">Catat Transaksi</button>
                                    </div>
                                )}

                                <div className="space-y-3">
                                    <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Aktivitas Terakhir</h3>
                                    {history.map(t => (
                                        <div key={t.idDoc} className="glass p-4 rounded-2xl flex justify-between items-center">
                                            <span className="text-xs font-bold uppercase">{t.ket}</span>
                                            <span className={`text-xs font-black ${t.tipe === 'masuk' ? 'text-green-500' : 'text-red-500'}`}>
                                                {t.tipe === 'masuk' ? '+' : '-'} Rp {t.total.toLocaleString()}
                                            </span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'iuran' && (
                            <div className="space-y-4">
                                <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Tabel Iuran Bulanan</h3>
                                <div className="overflow-x-auto no-scrollbar rounded-3xl glass border border-white/5">
                                    <table className="w-full">
                                        <thead className="bg-slate-900/50">
                                            <tr>
                                                <th className="p-4 text-[9px] font-black sticky left-0 bg-[#0f172a] z-10 border-r border-white/5">NAMA</th>
                                                {months.map(m => <th key={m} className="p-4 text-[9px] font-black text-center">{m}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {members.map(m => (
                                                <tr key={m.idDoc} className="border-t border-white/5">
                                                    <td className="p-4 text-[10px] font-black sticky left-0 bg-[#0f172a] z-10 border-r border-white/5 uppercase truncate max-w-[100px]">{m.name}</td>
                                                    {months.map(mon => (
                                                        <td key={mon} className="p-2 text-center">
                                                            <button 
                                                                disabled={!editMode}
                                                                onClick={() => toggleIuran(m.idDoc, m.paid || {}, mon)}
                                                                className={`w-7 h-7 mx-auto rounded-lg flex items-center justify-center transition-all ${m.paid?.[mon] ? 'bg-green-500 text-white' : 'bg-slate-800/50 text-slate-700'}`}
                                                            >
                                                                <i className={`fas ${m.paid?.[mon] ? 'fa-check' : 'fa-times'} text-[8px]`}></i>
                                                            </button>
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'tim' && (
                            <div className="space-y-4">
                                <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Daftar Panitia & Anggota</h3>
                                {members.map((m) => (
                                    <div key={m.idDoc} className="glass p-5 rounded-[2rem] border-l-4 border-blue-600 space-y-3">
                                        <div className="flex items-center gap-4">
                                            <div className="w-10 h-10 bg-slate-900 rounded-2xl flex items-center justify-center font-black text-xs text-blue-500 border border-white/5">{m.id}</div>
                                            <div className="flex-1">
                                                {editMode ? (
                                                    <input 
                                                        className="w-full bg-slate-800/50 px-3 py-1 rounded-lg text-sm font-black uppercase text-blue-400 border border-blue-500/30"
                                                        value={m.name}
                                                        onChange={(e) => updateMemberData(m.idDoc, 'name', e.target.value.toUpperCase())}
                                                    />
                                                ) : (
                                                    <p className="text-sm font-black uppercase tracking-tight">{m.name}</p>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Input WhatsApp hanya muncul di Mode Admin */}
                                        <div className="flex items-center gap-3">
                                            {editMode ? (
                                                <div className="flex-1 flex items-center bg-slate-950 rounded-xl px-3 border border-white/5">
                                                    <i className="fab fa-whatsapp text-green-500 text-xs mr-2"></i>
                                                    <input 
                                                        placeholder="628xxxxxxx"
                                                        className="w-full bg-transparent py-2 text-[10px] outline-none font-mono"
                                                        value={m.whatsapp || ''}
                                                        onChange={(e) => updateMemberData(m.idDoc, 'whatsapp', e.target.value)}
                                                    />
                                                </div>
                                            ) : (
                                                m.whatsapp && (
                                                    <button 
                                                        onClick={() => window.open(`https://wa.me/${m.whatsapp.replace(/\D/g,'')}?text=Halo%20${m.name},%20ini%20dari%20Admin%20DEVO%20Mobile.`)}
                                                        className="flex items-center gap-2 bg-green-500/10 text-green-500 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-green-500 hover:text-white transition-all"
                                                    >
                                                        <i className="fab fa-whatsapp text-sm"></i>
                                                        CHAT WHATSAPP
                                                    </button>
                                                )
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Navigasi */}
                    <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-slate-900/95 backdrop-blur-2xl p-4 px-10 flex justify-between items-center rounded-t-[2.5rem] border-t border-white/5 z-50">
                        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-blue-500' : 'text-slate-600'}`}>
                            <i className="fas fa-home text-xl"></i>
                            <span className="text-[8px] font-black uppercase">Home</span>
                        </button>
                        <button onClick={() => setActiveTab('iuran')} className={`flex flex-col items-center gap-1 ${activeTab === 'iuran' ? 'text-blue-500' : 'text-slate-600'}`}>
                            <i className="fas fa-file-invoice-dollar text-xl"></i>
                            <span className="text-[8px] font-black uppercase">Iuran</span>
                        </button>
                        <button onClick={() => setActiveTab('tim')} className={`flex flex-col items-center gap-1 ${activeTab === 'tim' ? 'text-blue-500' : 'text-slate-600'}`}>
                            <i className="fas fa-user-group text-xl"></i>
                            <span className="text-[8px] font-black uppercase">Tim</span>
                        </button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
