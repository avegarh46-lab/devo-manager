<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Devo Manager</title>
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- React & Firebase SDKs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-950">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- KONFIGURASI FIREBASE ---
        // Catatan: Variabel __firebase_config disediakan oleh environment Canvas
        const firebaseConfig = JSON.parse(__firebase_config);
        
        // Import Firebase dari CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'devo-manager-v1';
        const DEVO_LOGO = "https://lh3.googleusercontent.com/d/1X6GgS2w9r3mG_fS_Q4u1_hS4Z6G8J9_B";

        function App() {
            const [user, setUser] = useState(null);
            const [page, setPage] = useState('login');
            const [members, setMembers] = useState([]);
            const [finance, setFinance] = useState([]);
            const [iuran, setIuran] = useState({});
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedImg, setSelectedImg] = useState(null);
            const [loading, setLoading] = useState(false);
            const [viewImg, setViewImg] = useState(null);
            const [editSlot, setEditSlot] = useState(null);

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];

            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(u) setPage('dashboard');
                });
            }, []);

            useEffect(() => {
                if (!user) return;

                // Sync Anggota
                const unsubMem = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'members'), (snap) => {
                    const data = snap.docs.map(d => d.data());
                    const list = Array.from({length: 50}, (_, i) => {
                        const found = data.find(m => m.slotIndex === i);
                        return found || { slotIndex: i, name: `Anggota ${i+1}`, status: 'empty' };
                    });
                    setMembers(list);
                });

                // Sync Keuangan
                const unsubFin = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'finance'), (snap) => {
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setFinance(data.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal)));
                });

                // Sync Iuran
                const unsubIur = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'iuran'), (snap) => {
                    const obj = {};
                    snap.docs.forEach(d => obj[d.id] = d.data());
                    setIuran(obj);
                });

                return () => { unsubMem(); unsubFin(); unsubIur(); };
            }, [user]);

            const handleUpdateMember = async (i, val) => {
                if(!val.trim()) return setEditSlot(null);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', `slot_${i}`), {
                    slotIndex: i, name: val, status: 'active'
                });
                setEditSlot(null);
            };

            const handleToggleIuran = async (i, m) => {
                const id = `iuran_slot_${i}`;
                const status = iuran[id]?.[m] || false;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'iuran', id), {
                    [m]: !status
                }, { merge: true });
            };

            const handleSaveFin = async (e) => {
                e.preventDefault();
                setLoading(true);
                const fd = new FormData(e.target);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'finance'), {
                    keterangan: fd.get('ket'),
                    jumlah: parseInt(fd.get('nom')),
                    tipe: fd.get('tipe'),
                    tanggal: new Date().toISOString(),
                    bukti: selectedImg
                });
                setLoading(false);
                setIsModalOpen(false);
                setSelectedImg(null);
            };

            if (page === 'login') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-8 text-white text-center">
                    <img src={DEVO_LOGO} className="w-40 h-40 object-contain mb-8 animate-pulse" />
                    <h1 className="text-4xl font-black italic mb-2 tracking-tighter">DEVO <span className="text-blue-500">FC</span></h1>
                    <p className="text-slate-500 text-xs font-bold tracking-[0.4em] mb-12 uppercase">Internal Manager</p>
                    <button onClick={() => setPage('dashboard')} className="w-full max-w-xs bg-blue-600 py-4 rounded-2xl font-black tracking-widest text-sm shadow-xl shadow-blue-600/30">MULAI SEKARANG</button>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen text-white pb-32">
                    {/* Top Bar */}
                    <div className="p-6 sticky top-0 bg-slate-950/80 backdrop-blur-xl z-50 flex justify-between items-center border-b border-white/5">
                        <div className="flex items-center gap-3">
                            <img src={DEVO_LOGO} className="w-8 h-8" />
                            <h2 className="text-xs font-black uppercase italic tracking-widest">{page}</h2>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span className="text-[10px] font-bold text-slate-500 uppercase">Terhubung</span>
                        </div>
                    </div>

                    <div className="p-6">
                        {page === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="bg-gradient-to-br from-blue-600 to-indigo-900 p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden border border-white/10">
                                    <p className="text-xs font-bold text-blue-200 uppercase tracking-widest opacity-60">Total Kas Organisasi</p>
                                    <h3 className="text-4xl font-black mt-2">Rp {finance.reduce((a,c) => c.tipe==='masuk'?a+c.jumlah:a-c.jumlah, 0).toLocaleString('id-ID')}</h3>
                                    <div className="mt-8 flex gap-3 overflow-x-auto pb-2">
                                        <div className="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-black whitespace-nowrap">{members.filter(m=>m.status==='active').length} Anggota</div>
                                        <div className="bg-white/10 px-4 py-2 rounded-xl text-[10px] font-black whitespace-nowrap">Musim 2024/2025</div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={()=>setPage('anggota')} className="bg-slate-900 p-6 rounded-[2rem] border border-white/5 text-left active:scale-95 transition-all">
                                        <i className="fas fa-users-cog text-blue-500 text-2xl mb-4"></i>
                                        <p className="text-xs font-black uppercase">Anggota</p>
                                    </button>
                                    <button onClick={()=>setPage('iuran')} className="bg-slate-900 p-6 rounded-[2rem] border border-white/5 text-left active:scale-95 transition-all">
                                        <i className="fas fa-hand-holding-dollar text-green-500 text-2xl mb-4"></i>
                                        <p className="text-xs font-black uppercase">Cek Iuran</p>
                                    </button>
                                </div>
                            </div>
                        )}

                        {page === 'anggota' && (
                            <div className="space-y-3">
                                <p className="text-[10px] font-black text-slate-500 mb-4 tracking-widest">KELOLA 50 SLOT ANGGOTA</p>
                                {members.map((m, i) => (
                                    <div key={i} className="bg-slate-900 p-4 rounded-2xl border border-white/5 flex items-center gap-4">
                                        <span className="text-[10px] font-mono text-slate-700 w-5">{i+1}</span>
                                        <div className="flex-1">
                                            {editSlot === i ? (
                                                <input autoFocus onBlur={(e)=>handleUpdateMember(i, e.target.value)} onKeyDown={(e)=>e.key==='Enter'&&handleUpdateMember(i,e.target.value)} defaultValue={m.status==='empty'?'':m.name} className="w-full bg-transparent border-b border-blue-500 outline-none text-sm font-bold" />
                                            ) : (
                                                <p onClick={()=>setEditSlot(i)} className={`text-sm ${m.status==='empty'?'text-slate-700 italic':'font-black'}`}>{m.name}</p>
                                            )}
                                        </div>
                                        {m.status==='active' && <i className="fas fa-check-circle text-blue-500 text-[10px]"></i>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {page === 'iuran' && (
                            <div className="overflow-x-auto rounded-3xl border border-white/5 bg-slate-900/50">
                                <table className="w-full text-left border-collapse min-w-[800px]">
                                    <thead>
                                        <tr>
                                            <th className="p-5 text-[10px] font-black text-slate-500 sticky left-0 bg-slate-900 z-10">NAMA</th>
                                            {months.map(m => <th key={m} className="p-5 text-[10px] font-black text-slate-500 text-center">{m}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {members.filter(m=>m.status==='active').map((m, i) => (
                                            <tr key={i} className="border-t border-white/5">
                                                <td className="p-5 text-xs font-black sticky left-0 bg-slate-950/80 backdrop-blur-md z-10 truncate">{m.name}</td>
                                                {months.map(mon => (
                                                    <td key={mon} className="p-2 text-center">
                                                        <button onClick={()=>handleToggleIuran(m.slotIndex, mon)} className={`w-8 h-8 rounded-xl flex items-center justify-center transition-all ${iuran[`iuran_slot_${m.slotIndex}`]?.[mon] ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-600'}`}>
                                                            <i className={`fas ${iuran[`iuran_slot_${m.slotIndex}`]?.[mon] ? 'fa-check' : 'fa-times'} text-[10px]`}></i>
                                                        </button>
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {page === 'keuangan' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-sm font-black text-slate-500 tracking-widest">LOG TRANSAKSI</h3>
                                    <button onClick={()=>setIsModalOpen(true)} className="bg-blue-600 px-5 py-2 rounded-xl text-[10px] font-black">INPUT NOTA</button>
                                </div>
                                {finance.map(f => (
                                    <div key={f.id} className="bg-slate-900/50 p-5 rounded-[2rem] border border-white/5 flex justify-between items-center">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-10 h-10 rounded-2xl flex items-center justify-center ${f.tipe==='masuk'?'bg-green-500/10 text-green-500':'bg-red-500/10 text-red-500'}`}>
                                                <i className={`fas fa-arrow-${f.tipe==='masuk'?'up':'down'} text-xs`}></i>
                                            </div>
                                            <div>
                                                <p className="text-sm font-black tracking-tight">{f.keterangan}</p>
                                                <div className="flex gap-3 items-center mt-1">
                                                    <span className="text-[9px] font-bold text-slate-600 uppercase">{new Date(f.tanggal).toLocaleDateString('id-ID')}</span>
                                                    {f.bukti && <button onClick={()=>setViewImg(f.bukti)} className="text-[9px] font-black text-blue-500 uppercase">Lampiran</button>}
                                                </div>
                                            </div>
                                        </div>
                                        <p className={`font-black ${f.tipe==='masuk'?'text-green-500':'text-red-500'}`}>{f.tipe==='masuk'?'+':'-'} {f.jumlah.toLocaleString('id-ID')}</p>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Nav Bar */}
                    <nav className="fixed bottom-8 left-6 right-6 bg-slate-900/90 backdrop-blur-2xl border border-white/10 p-3 flex justify-around items-center z-50 rounded-[2.5rem] shadow-2xl">
                        <button onClick={()=>setPage('dashboard')} className={`p-4 rounded-2xl ${page==='dashboard'?'bg-blue-600 text-white shadow-lg shadow-blue-600/30':'text-slate-500'}`}><i className="fas fa-grid-2 text-xl"></i></button>
                        <button onClick={()=>setPage('anggota')} className={`p-4 rounded-2xl ${page==='anggota'?'bg-blue-600 text-white shadow-lg shadow-blue-600/30':'text-slate-500'}`}><i className="fas fa-users text-xl"></i></button>
                        <button onClick={()=>setIsModalOpen(true)} className="w-14 h-14 bg-white text-slate-950 rounded-2xl flex items-center justify-center shadow-2xl active:scale-90 transition-all"><i className="fas fa-camera text-xl"></i></button>
                        <button onClick={()=>setPage('iuran')} className={`p-4 rounded-2xl ${page==='iuran'?'bg-blue-600 text-white shadow-lg shadow-blue-600/30':'text-slate-500'}`}><i className="fas fa-file-invoice-dollar text-xl"></i></button>
                        <button onClick={()=>setPage('keuangan')} className={`p-4 rounded-2xl ${page==='keuangan'?'bg-blue-600 text-white shadow-lg shadow-blue-600/30':'text-slate-500'}`}><i className="fas fa-wallet text-xl"></i></button>
                    </nav>

                    {/* Modal Input */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] bg-black/90 flex items-end justify-center p-4 animate-in fade-in duration-300">
                            <div className="bg-slate-900 w-full max-w-md rounded-[3rem] p-8 border border-white/10 animate-in slide-in-from-bottom duration-500">
                                <div className="flex justify-between items-center mb-8">
                                    <h3 className="font-black italic">BARU</h3>
                                    <button onClick={()=>setIsModalOpen(false)}><i className="fas fa-times-circle text-2xl text-slate-700"></i></button>
                                </div>
                                <form onSubmit={handleSaveFin} className="space-y-4">
                                    <div className="flex gap-2">
                                        <label className="flex-1">
                                            <input type="radio" name="tipe" value="masuk" defaultChecked className="hidden peer" />
                                            <div className="text-center py-3 rounded-xl bg-slate-800 border-2 border-transparent peer-checked:border-green-500 peer-checked:bg-green-500/10 text-[10px] font-black">UANG MASUK</div>
                                        </label>
                                        <label className="flex-1">
                                            <input type="radio" name="tipe" value="keluar" className="hidden peer" />
                                            <div className="text-center py-3 rounded-xl bg-slate-800 border-2 border-transparent peer-checked:border-red-500 peer-checked:bg-red-500/10 text-[10px] font-black">UANG KELUAR</div>
                                        </label>
                                    </div>
                                    <input name="ket" required placeholder="Keterangan..." className="w-full bg-slate-800 rounded-xl p-4 text-sm outline-none" />
                                    <input name="nom" type="number" required placeholder="Nominal Rp..." className="w-full bg-slate-800 rounded-xl p-4 text-sm outline-none font-mono" />
                                    <div onClick={()=>document.getElementById('finImg').click()} className="w-full aspect-video bg-slate-800 rounded-2xl border-2 border-dashed border-white/5 flex flex-col items-center justify-center overflow-hidden cursor-pointer">
                                        {selectedImg ? <img src={selectedImg} className="w-full h-full object-cover" /> : <><i className="fas fa-camera text-2xl mb-2 opacity-20"></i><p className="text-[10px] font-bold opacity-30 uppercase">Foto Nota</p></>}
                                    </div>
                                    <input id="finImg" type="file" accept="image/*" capture="environment" className="hidden" onChange={(e)=>{
                                        const r = new FileReader();
                                        r.onload = () => setSelectedImg(r.result);
                                        r.readAsDataURL(e.target.files[0]);
                                    }} />
                                    <button disabled={loading} className="w-full bg-white text-slate-950 py-4 rounded-2xl font-black text-sm tracking-widest">{loading ? "MENYIMPAN..." : "SIMPAN DATA"}</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Viewer Gambar */}
                    {viewImg && (
                        <div className="fixed inset-0 z-[200] bg-black/95 flex items-center justify-center p-6" onClick={()=>setViewImg(null)}>
                            <img src={viewImg} className="max-w-full max-h-full rounded-2xl" />
                            <p className="absolute bottom-10 text-[10px] font-black text-slate-500 uppercase tracking-widest italic">Ketuk dimana saja untuk tutup</p>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

